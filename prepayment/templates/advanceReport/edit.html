{% extends 'main/base.html' %}

{% block title %}
  Авансовый отчет
{% endblock %}

{% block content %}
  <style rel="stylesheet" type="text/css">
    .nav-link {
      padding: 0.1rem 0.5rem;
    }
    .col-num-row td{
      padding: 0;
    }
    td>input {
      text-align: center;
    }
  </style>

  <form id="mainForm" method="post" class="container-fluid" enctype="multipart/form-data">
    {% csrf_token %}

    {% with imprestAccount=form.instance.imprestAccount.account|stringformat:"s" %}
      {% url 'advanceReports' as back_url %}
      {% if lockLevel < 2 %}
        {% include 'main/save_cancel.html' with path=back_url|add:'?imprestAccount='|add:imprestAccount %}
      {% else %}
        {% include 'main/save_cancel.html' with path=back_url|add:'?imprestAccount='|add:imprestAccount renderSave=False %}
      {% endif %}
    {% endwith %}

    {{ form.errors }}
    {{ form.non_field_errors }}
    {% comment %} {{ travelExpenses.errors }} {% endcomment %}
    {{ travelExpenses.non_field_errors }}
    {% comment %} {{ orgServices.errors }} {% endcomment %}
    {{ orgServices.non_field_errors }}
    {% comment %} {{ iventoryItems.errors }} {% endcomment %}
    {{ iventoryItems.non_field_errors }}
    {% comment %} {{ services.errors }} {% endcomment %}
    {{ services.non_field_errors }}
    {% comment %} {{ presentationExpenses.errors }} {% endcomment %}
    {{ presentationExpenses.non_field_errors }}
    {% comment %} {{ purchaseOrderExpenses.errors }} {% endcomment %}
    {{ purchaseOrderExpenses.non_field_errors }}
    {% comment %} {{ attachments.errors }} {% endcomment %}
    {{ attachments.non_field_errors }}

    <input type="hidden" name="id" value="{{ form.id.value }}" />
    <input id="mission-days" type="hidden" value="{{ form.instance.days|default_if_none:'' }}" />

    <input id="action" type="hidden" name="action">
    <input type="hidden" class="approve-date" name="{{ form.approveDate.name }}" value="{{ form.approveDate.value|default_if_none:'' }}" />
    <input type="hidden" class="approve-action-date" name="{{ form.approveActionDate.name }}" value="{{ form.approveActionDate.value|default_if_none:'' }}" />
    <input type="hidden" name="lockLevel" value="{{ lockLevel|default_if_none:'0' }}" />

    <div class="row g-1 mt-1">
      <div class="col-12 border rounded p-1">
        <div class="row g-1">
          <div class="col-xl-3 col-md-3 text-center">
            <h4 class="m-0 border rounded">Авансовый отчет <a href="{% url 'prepayments' %}/{{ form.instance.id }}" title="Перейти в выданный под отчет аванс"><i class="fa-duotone fa-money-bill-transfer"></i></a></h4>
          </div>

          <div class="col-xl-2 col-md-3">
            <div class="input-group input-group-sm">
              <span class="input-group-text">{{ form.reportNum.label }}</span>
              <input type="text" class="mb-0 form-control form-control-sm" value="{{ form.instance.reportNum|default_if_none:'' }}" disabled />
            </div>
          </div>

          <div class="col-xl-2 col-md-3">
            <div class="input-group input-group-sm">
              <span class="input-group-text">{{ form.reportDate.label }}</span>
              <input type="text" class="text-center mb-0 form-control form-control-sm" value="{{ form.instance.reportDate|default_if_none:'' }}" disabled />
            </div>
          </div>

          <div class="col-xl-3 col-md-3 ms-auto">
            {% include 'main/input_group.html' with field=form.reportStatus inputClass='text-center form-select' %}
          </div>
        </div>
      </div>

      <div class="col-12 border rounded p-1">
        <div class="row g-1">
          <div class="col-6">
            {% include 'advanceReport/division_block.html' %}
          </div>

          <div class="col-3">
            {% include 'main/input_group.html' with field=form.reportAccountingNum inputClass='align-items-end justify-content-center' inputGroupClass='h-100'%}
          </div>

          <div class="col text-end">
            <small>Создан: {{ form.instance.createdAt }}</small>
            {% if form.instance.approveDate %}
              <br/>
              <small>Проводки подтверждены: {{ form.instance.approveDate }}</small>
            {% endif %}
          </div>

          <div class="col-auto text-center pt-3 ps-3">
            {% if lockLevel > 0 %}
              <i class="fa-duotone fa-lock-keyhole text-danger fa-xl" title="Уровень блокировки:&#13;&#10;0 - Корректировка АО&#13;&#10;1 - Проводки подтверждены&#13;&#10;2 - Проводки выгружены"></i> - {{ lockLevel }}
            {% endif %}
          </div>
        </div>
      </div>

      <div class="col-12 border rounded p-1">
        <div class="row g-1">
          <div class="col-sm-6 col-xl-4">
            <div class="input-group input-group-sm">
              <span class="input-group-text">Подотчетное лицо*</span>
              <input id="emp-full-name" type="text" class="form-control" value="{{ form.instance.empFullName|default_if_none:'' }}" disabled />
            </div>
          </div>

          <div class="col-sm-6 col-xl-3">
            <div class="input-group input-group-sm">
              <span class="input-group-text">Табельный номер</span>
              <input id="emp-num-input" type="text" class="text-center form-control" value="{{ form.instance.empNum|default_if_none:'' }}" disabled />
            </div>
          </div>

          <div class="col-sm-6 col-xl-5">
            <div class="input-group input-group-sm">
              <span class="input-group-text">Должность</span>
              <input id="emp-prof-name" type="text" class="form-control" value="{{ form.instance.empProfName|default_if_none:'' }}" disabled />
            </div>
          </div>

          <div class="col-sm-6 col-xl-4">
            {% include 'main/input_group.html' with field=form.phone %}
          </div>

          <div class="col-sm-12">
            <div class="input-group input-group-sm">
              <span class="input-group-text">Назначение аванса*</span>
              <input type="text" class="mb-0 form-control form-control-sm" value="{{ form.instance.prepaidDestList|default_if_none:'' }}" disabled />
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 border rounded p-1">
        <div class="row g-1">
          <div class="col-sm-4 col-xl-4">
            {% include 'main/input_group.html' with field=form.contractIdentifier label='Идентификатор государственного<br />контракта' %}
          </div>
          <div class="col-sm-2 col-xl-2">
            <div class="input-group input-group-sm h-100">
              <span class="input-group-text">Приказ</span>
              <input class="form-control text-center" value="{% if form.instance.document_id == 14 %}{{ form.instance.docNum }}{% endif %}" disabled/>
            </div>
          </div>

          <div class="col-sm-3 col-xl-3">
            <div class="input-group input-group-sm h-100">
              <span class="input-group-text text-left">Номер заявки в ЕОСДО,<br />заявления, ЭД</span>
              <input class="form-control text-center" value="{% if form.instance.document_id == 5 %}{{ form.instance.docNum }}{% endif %}" disabled/>
              {% if form.instance.request_id %}
                <a class="btn btn-outline-primary d-flex align-items-center" href="{% url 'requests' %}/{{ form.instance.request_id }}" title="Перейти в заявку"><i class="fa-duotone fa-file-signature"></i></a>
              {% endif %}
            </div>
          </div>

          <div class="col-sm-3 col-xl-3">
            <div class="input-group input-group-sm h-100">
              <span class="input-group-text">Дата документа</span>
              <input class="form-control text-center" value="{{ form.instance.docDate }}" disabled/>
            </div>
          </div>

        </div>
      </div>

      <div class="col-12 border rounded p-1">
        <div class="row g-1">
          <div class="col-sm-3 col-xl-3">
            <div class="input-group input-group-sm">
              <span class="input-group-text text-left" style="font-size: 0.7em;">A.I. Получен аванс подотчетным<br />лицом, руб. коп.:</span>
              <input id="total-sum" type="text" class="mb-0 form-control form-control-sm h-auto" name="{{ form.totalSum.name }}" value="{{ form.instance.totalSum|default_if_none:'' }}" readonly />
            </div>
          </div>

          <div class="col-sm-2 col-xl-2">
            <div class="input-group input-group-sm">
              <span class="input-group-text" style="font-size: 0.7em;">A.II. Израсходовано<br />всего, руб. коп.:</span>
              <input id="spended-sum" type="text" class="mb-0 form-control form-control-sm h-auto" value="{{ form.spendedSum.value|default_if_none:'' }}" readonly title="Расчитывается автоматически после сохранения" />
            </div>
          </div>

          <div class="col-sm-4 col-xl-4">
            <div class="input-group input-group-sm">
              <span class="input-group-text text-left" style="font-size: 0.7em;">A.III. Остаток/перерасход по авансу,<br />полученному подотчетным лицом, руб. коп.:</span>
              <input id="dif-sum" type="text" class="mb-0 form-control form-control-sm h-auto" readonly />
              <button id="distrib-button" type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#distribModal">Распределить</button>
            </div>
          </div>

          <div class="col-sm-3 col-xl-3">
            {% include 'main/input_group.html' with field=form.reportAccountingSum label='Сумма по бухгалтерской<br />справке' labelStyle='font-size: 0.7em;' %}
          </div>

        </div>
      </div>

      {% if form.instance.reportStatus_id == 3 and lockLevel|stringformat:"s" in '10' %}
        <div class="col-12 border rounded p-1">
          <div class="row g-1">
            <div class="col">
              {% if lockLevel == 1 %}
                <button class="btn btn-sm btn-outline-primary mr-1 unlock">Корректировка проводки</button>
              {% endif %}
              {% if lockLevel == 0 %}
                <button type="button" class="btn btn-sm btn-outline-primary mr-1" data-bs-toggle="modal" data-bs-target="#approveModal">Подтвердить проводки</button>
              {% endif %}
          </div>
          </div>
        </div>
      {% endif %}

      <div class="col-12 border rounded p-1">
        <ul class="nav nav-tabs w-100" id="myTab" style="font-size: 0.8em;" role="tablist">
          {% if form.instance.imprestAccount_id != 7104 and form.instance.imprestAccount_id != 7106 %}
            <li class="nav-item" role="presentation">
              <button class="nav-link active h-100" id="tab-1" data-bs-toggle="tab" data-bs-target="#tab-content-1" type="button" role="tab" aria-controls="tab-content-1" aria-selected="true">Командировочные расходы</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link h-100" id="tab-2" data-bs-toggle="tab" data-bs-target="#tab-content-2" type="button" role="tab" aria-controls="tab-content-2" aria-selected="false">Расходы, оплаченные организацией за услуги проезда,<br />проживания подотчетного лица и пр.услуги</button>
            </li>
          {% endif %}
          <li class="nav-item" role="presentation">
            <button class="nav-link h-100 {% if form.instance.imprestAccount_id == 7104 or form.instance.imprestAccount_id == 7106 %} active {% endif %}" id="tab-3" data-bs-toggle="tab" data-bs-target="#tab-content-3" type="button" role="tab" aria-controls="tab-content-3" aria-selected="false">Приобретение ТМЦ</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link h-100" id="tab-4" data-bs-toggle="tab" data-bs-target="#tab-content-4" type="button" role="tab" aria-controls="tab-content-4" aria-selected="false">Оплата работ, услуг</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link h-100" id="tab-5" data-bs-toggle="tab" data-bs-target="#tab-content-5" type="button" role="tab" aria-controls="tab-content-5" aria-selected="false">Представительские расходы</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link h-100" id="tab-6" data-bs-toggle="tab" data-bs-target="#tab-content-6" type="button" role="tab" aria-controls="tab-content-6" aria-selected="false">Оплата заказ-наряда</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link h-100" id="tab-7" data-bs-toggle="tab" data-bs-target="#tab-content-7" type="button" role="tab" aria-controls="tab-content-7" aria-selected="false">Приложение</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link h-100" id="tab-8" data-bs-toggle="tab" data-bs-target="#tab-content-8" type="button" role="tab" aria-controls="tab-content-8" aria-selected="false">Сообщение</button>
          </li>
        </ul>
        <div class="tab-content border" id="tabContent">
          {% if form.instance.imprestAccount_id != 7104 and form.instance.imprestAccount_id != 7106 %}
            <div class="tab-pane fade show active container-fluid" id="tab-content-1" role="tabpanel" aria-labelledby="tab-1">
              <div class="row p-1">
                {% if not lockLevel %}
                  <div class="col p-0">
                    <button class="btn btn-sm btn-outline-primary btn-add-row" data-prefix="{{ travelExpenses.prefix }}">Добавить</button>
                  </div>
                {% endif %}
              </div>

              <div class="row p-1">
                {% include 'advanceReport/itemTable.html' with items=travelExpenses itemType=0 accounting=True %}
              </div>
            </div>

            <div class="tab-pane fade container-fluid" id="tab-content-2" role="tabpanel" aria-labelledby="tab-2">
              <div class="row p-1">
                {% if not lockLevel %}
                  <div class="col p-0">
                    <button class="btn btn-sm btn-outline-primary btn-add-row" data-prefix="{{ orgServices.prefix }}">Добавить</button>
                  </div>
                {% endif %}
              </div>

              <div class="row p-1">
                {% include 'advanceReport/itemTable.html' with items=orgServices itemType=1 %}
              </div>
            </div>
          {% endif %}

          <div class="tab-pane fade container-fluid {% if form.instance.imprestAccount_id == 7104 or form.instance.imprestAccount_id == 7106 %} show active {% endif %}" id="tab-content-3" role="tabpanel" aria-labelledby="tab-3">
            <div class="row p-1">
              {% if not lockLevel %}
                <div class="col p-0">
                  <button class="btn btn-sm btn-outline-primary btn-add-row" data-prefix="{{ iventoryItems.prefix }}">Добавить</button>
                </div>
              {% endif %}
            </div>

            <div class="row p-1">
              {% include 'advanceReport/itemTable.html' with items=iventoryItems itemType=2 accounting=True %}
            </div>
          </div>
          <div class="tab-pane fade container-fluid" id="tab-content-4" role="tabpanel" aria-labelledby="tab-4">
            <div class="row p-1">
              {% if not lockLevel %}
                <div class="col p-0">
                  <button class="btn btn-sm btn-outline-primary btn-add-row" data-prefix="{{ services.prefix }}">Добавить</button>
                </div>
              {% endif %}
            </div>

            <div class="row p-1">
              {% include 'advanceReport/itemTable.html' with items=services itemType=3 %}
            </div>
          </div>
          <div class="tab-pane fade container-fluid" id="tab-content-5" role="tabpanel" aria-labelledby="tab-5">
            <div class="row p-1">
              {% if not lockLevel %}
                <div class="col p-0">
                  <button class="btn btn-sm btn-outline-primary btn-add-row" data-prefix="{{ presentationExpenses.prefix }}">Добавить</button>
                </div>
              {% endif %}
            </div>

            <div class="row p-1">
              {% include 'advanceReport/itemTable.html' with items=presentationExpenses itemType=4 %}
            </div>
          </div>
          <div class="tab-pane fade container-fluid" id="tab-content-6" role="tabpanel" aria-labelledby="tab-6">
            <div class="row p-1">
              {% if not lockLevel %}
                <div class="col p-0">
                  <button class="btn btn-sm btn-outline-primary btn-add-row" data-prefix="{{ purchaseOrderExpenses.prefix }}">Добавить</button>
                </div>
              {% endif %}
            </div>

            <div class="row p-1">
              {% include 'advanceReport/itemTable.html' with items=purchaseOrderExpenses itemType=5 %}
            </div>
          </div>
          <div class="tab-pane fade container-fluid" id="tab-content-7" role="tabpanel" aria-labelledby="tab-7">
            <div class="row p-1">
              {% if not lockLevel %}
                <div class="col p-0">
                  <button type="button" class="btn btn-sm btn-outline-primary btn-add-row" data-prefix="{{ attachments.prefix }}">Добавить</button>
                </div>
              {% endif %}
            </div>

            <div class="row p-1">
              <table class="table table-bordered table-sm text-center">
                <thead>
                  <th>Наименование</th>
                  <th style="width: 10%;">Дата прикрепления</th>
                  <th>Просмотр</th>
                  <th style="width: 40%;">Загрузить</th>
                  <th style="width: 3%;"></th>
                </thead>
                <tbody class="{{ attachments.prefix }}-container">
                  {{ attachments.management_form }}
                  {% for attachment in attachments %}
                    <tr class="{{ attachments.prefix }}-form">
                      {{ attachment.id }}
                      <input type="hidden" name="{{ attachment.DELETE.html_name }}" id="{{ attachment.DELETE.auto_id }}" />
                      <td>
                        <input type="text" class="form-control form-control-sm file-name" name="{{ attachment.name.html_name }}" value="{{ attachment.name.value|default_if_none:'' }}" autocomplete="off" />
                      </td>
                      <td>
                        <input type="text" class="form-control form-control-sm datepeeker file-date" name="{{ attachment.date.html_name }}" value="{{ attachment.date.value|default_if_none:'' }}" autocomplete="off" />
                      </td>
                      <td>
                        {% if attachment.file.value is not None %}
                          <a href="{{ attachment.file.value.url|urlencode }}" target="__blank" title="{{ attachment.file.value }}">Просмотр</a>
                        {% endif %}
                      </td>
                      <td>
                        <input type="file" name="{{ attachment.file.html_name }}" class="form-control-file" />
                      </td>
                      <td>
                        <button type="button" class="btn btn-sm btn-outline-danger row-delete"><i class="fa-light fa-trash"></i></button>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
          <div class="tab-pane fade container-fluid" id="tab-content-8" role="tabpanel" aria-labelledby="tab-8">
            <div class="row">
              <div class="col-12 p-1">
                <div class="input-group input-group-sm">
                    <span class="input-group-text">Примечание</span>
                    <textarea class="mb-0 form-control form-control-sm {% if form.reportComment.errors %} is-invalid {% endif %}" name="{{ form.reportComment.name }}">{{ form.reportComment.value|default_if_none:'' }}</textarea>
                  </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    {% include 'advanceReport/distributeModal.html' with modal_id='distribModal' render_cancel=False %}

  </form>

  {% comment %} {% include 'advanceReport/inventoryModal.html' %} {% endcomment %}

  {% include 'advanceReport/approveModal.html' with modal_id='approveModal' submit_form_id='mainForm' modal_size='xs' %}

  {% include 'advanceReport/approveModal.html' with modal_id='entityApproveModal' submit_form_id='mainForm' modal_size='xs' %}

  {% include 'advanceReport/serviceModal.html' with modal_id='serviceModal' %}

  {% include 'advanceReport/presentationModal.html' with modal_id='presentationModal' %}

  {% include 'advanceReport/purchaseOrderModal.html' with modal_id='purchaseOrderModal' %}

  <script type="text/javascript">
    var editRow
    const format = $.fn.dataTable.render.number(' ', ',', 2).display
    
    function updateTotal (tabDiv) {
      var sum_currency = 0, sum_rub = 0, sum_vat = 0, accounting_sum = 0;
      $(tabDiv).find('input.expense-sum, input.accounting-sum').each(function(){
        if (this.value)
          if (this.classList.contains("expense-sum-currency"))
            sum_currency += parseFloat(this.value.replace(/,/g, '.'))
          else if (this.classList.contains("expense-sum-rub"))
            sum_rub += parseFloat(this.value.replace(/,/g, '.'))
          else if (this.classList.contains("expense-sum-vat"))
            sum_vat += parseFloat(this.value.replace(/,/g, '.'))
          else if (this.classList.contains("accounting-sum"))
            if ($(this).closest('tr').find('input[name$="creditAccount"][value^="71"]').length)
              accounting_sum += parseFloat(this.value.replace(/,/g, '.'))
      });
      $(tabDiv).find('.expense-sum-currency-total').text(format(sum_currency))
      $(tabDiv).find('.expense-sum-rub-total').text(format(sum_rub))
      $(tabDiv).find('.expense-sum-vat-total').text(format(sum_vat))
      $(tabDiv).find('.accounting-sum-total').text(format(accounting_sum))
      $(tabDiv).find('.accounting-diff-total').text(format(sum_rub - accounting_sum))
    }

    $(document).ready(function () {
      $('#button-add-item').on('click', function (e) {
        addForm('item')
      })
    
      window.location.hash && $(window.location.hash).tab('show');

      $('.nav-tabs button').click(function (e) {
        window.location.hash = e.target.id;
      });

      // При показе таба обновляем итоги
      $('button[data-bs-toggle="tab"]').on('shown.bs.tab', function (e) {
        //console.log(e.target)
        //console.log(e.relatedTarget)
        updateTotal($(e.target.dataset.target))
      })

      // Добавить элемент авансового отчета
      $('.btn-add-row, .btn-add-entity-row').on('click', function (e) {
        $('#action').val('add-' + $(e.target).data('prefix'))
        //const form = addForm($(e.target).data('prefix'))
        //$(form).find('.datepeeker').removeAttr('id').removeClass('hasDatepicker').datepicker()
      })

      // Удалить элемент авансового отчета
      $('.btn-delete-row').on('click', function (e) {
        $('#action').val('delete-' + $(e.currentTarget).data('prefix'))
      })

      // Заполнить элемент авансового отчета
      $('.btn-fill-entity-row').on('click', function (e) {
        $('#action').val('fill-' + $(e.currentTarget).data('prefix'))
      })

       // Сторнировать
      $('.row-storno').on('click', function (e) {
        $('#action').val('storno-' + $(e.currentTarget).data('prefix'))
      })
    
      $('tbody').on('click', '.row-delete', function (e) {
        const tr = $(e.currentTarget).closest('tr')
        $('.'+tr.attr('id')).hide()
        tr.hide()
        tr.find("[id$='DELETE']").val(1)
      })
    
      $('.datepeeker').datepicker({
        beforeShow: function() {
          setTimeout(function(){
              $('.ui-datepicker').css('z-index', 99999999999999);
          }, 0);
        }
      })
    
      $('#div-search').on('click', function (e) {
        const divNum = $('#emp-div-num').val()
        if (!divNum) {
          alert('Введите номер подразделения')
          return
        }
        $.get(`/api/v1/departments/${divNum}/?format=json`, function (data) {
          if (data) {
            $('#emp-div-name').val(data.name)
          } else {
            $('#emp-div-name').val('')
          }
        }).fail(function (e) {
          $('#emp-div-name').val('')
        })
      })
    
      $('#spended-sum').on('change', function (e) {
        const spended = $(this).val()
        const received = $('#total-sum').val()
    
        $('#dif-sum').val(stringDif(received, spended))
      })
      $('#spended-sum').trigger('change')

      $('div.tab-pane').on('change', 'input.expense-sum, input.accounting-sum', function(e){
        updateTotal(e.delegateTarget)
      })

      // Обработчик выбора наименования расхода для командировок
      $('#tab-content-1').on('change', '[id$="expenseCategory"]', function (e) {
        const selectElement = e.target
        const selectedText = selectElement.options[selectElement.selectedIndex].text
        //console.log(e.target.value)
        if (['38', '40', '39', '41'].includes(e.target.value)) {
          const tr = $(e.target).parents('tr')
          const daysCount = $('#mission-days').val()
          if (daysCount && selectedText) {
            $.get(`/api/v1/expenseRates/?format=json&name=${selectedText}`).done((response) => {
              if (response.results != null && response.results.length > 0)
                response.results.forEach(function(el){
                  if (el.name == selectedText)
                    tr.find('[name$="expenseSumRub"]').val(daysCount * el.value)
                })
            })
          }
          tr.find('[name$="daysCount"]').val(daysCount)
        }
      })

     // Обработчик отображения формы принятия проводки
     $('#entityApproveModal').on('show.bs.modal', function (event) {
        // Устанавливаем ссылку на редактируемую строку
        editRow = $(event.relatedTarget).closest('tr')
        var modal = $(this)
        const modalDateInput = modal.find("input.approve-date")
        const approveDateInput = editRow.find("input.entity-approve-date")
        modalDateInput.val(approveDateInput.val())
      })

      // Принятие проводки
      $('#entityApproveModal').on('click', '.ok-button', function(e){
        var modal = $(e.delegateTarget)
        const modalDateInput = modal.find("input.approve-date")
        const approveDateInput = editRow.find("input.entity-approve-date")
        //console.log(editRow)
        approveDateInput.val(modalDateInput.val())
      })

      // Обработчик отображения формы принятия проводок
      $('#approveModal').on('show.bs.modal', function (event) {
        var modal = $(this)
        const modalDateInput = modal.find("input.approve-date")
        const approveDateInput = $("form>input.approve-date")
        modalDateInput.val(approveDateInput.val())
      })
      // Принятие проводок
      $('#approveModal').on('click', '.ok-button', function(e){
        var modal = $(e.delegateTarget)
        const modalDateInput = modal.find("input.approve-date")
        const approveDateInput = $("form>input.approve-date")
        approveDateInput.val(modalDateInput.val())
        $('#action').val('lock')
      })
      // Корректировка проводок
      $('button.unlock').on('click', function (e) {
        $('#action').val('unlock')
      })

      // Обработчик отображения форм редактирования
      $('.inventoryModal, #serviceModal, #presentationModal, #purchaseOrderModal').on('show.bs.modal', function (event) {
        // Устанавливаем ссылку на редактируемую строку
        editRow = $(event.relatedTarget).closest('tr')
        const itemType = editRow.find('input.item-type').val()

        // Получаем общие поля ввода из редактируемой строки
        var rowDocumentSelect = editRow.find('select.approve-doc')
        var rowDocNumInput = editRow.find('.doc-num')
        var rowDocDateInput = editRow.find('.doc-date')
        var rowExpenseSumRubInput = editRow.find('.expense-sum-rub')
        var rowExpenseSumVATInput = editRow.find('.expense-sum-vat')
        var rowSypherNumInput = editRow.find('.sypher-num')
        var rowSypherDateInput = editRow.find('.sypher-date')
        var rowCommentInput = editRow.find('.comment')

        var modal = $(this)
        // Получаем поля ввода на модальной форме
        var modalDocNumInput = modal.find('.doc-num')
        var modalDocDateInput = modal.find('.doc-date')
        var modalExpenseSumRubInput = modal.find('.expense-sum-rub')
        var modalExpenseSumVATInput = modal.find('.expense-sum-vat')
        var modalSypherNumInput = modal.find('.sypher-num')
        var modalSypherDateInput = modal.find('.sypher-date')
        var modalCommentInput = modal.find('.comment')
        
        // Заменяем поле выбора документа
        modal.find('#approve-doc select').remove()
        var documentSelectClone = rowDocumentSelect.clone()
        documentSelectClone.appendTo(modal.find('#approve-doc'))
        
        // Выставляем значения из редактируемой строки
        documentSelectClone.val(rowDocumentSelect.val())
        modalDocNumInput.val(rowDocNumInput.val())
        modalDocDateInput.val(rowDocDateInput.val())

        modalExpenseSumRubInput.val(rowExpenseSumRubInput.val())
        modalExpenseSumVATInput.val(rowExpenseSumVATInput.val())

        modalSypherNumInput.val(rowSypherNumInput.val())
        modalSypherDateInput.val(rowSypherDateInput.val())
        modalCommentInput.val(rowCommentInput.val())

        // Приобретение ТМЦ
        if (itemType == 2) {
          // Получаем специфические поля ввода из редактируемой строки
          var rowRouteInput = editRow.find('.route')

          // Получаем поля ввода на модальной форме
          var modalRouteInput = modal.find('.route')

          // Выставляем значения из редактируемой строки
          modalRouteInput.val(rowRouteInput.val())
        }
        // Оплата работ, услуг, Представительские расходы
        else if (itemType == 3 || itemType == 4) {
          // Получаем специфические поля ввода из редактируемой строки
          var rowAccountInput = editRow.find('.account')
          var rowKAU1Input = editRow.find('.kau-1')
          var rowKAU2Input = editRow.find('.kau-2')
          var rowExtraInput = editRow.find('.extra')

          // Получаем поля ввода на модальной форме
          var modalAccountInput = modal.find('.account')
          var modalKAU1Input = modal.find('.kau-1')
          var modalKAU2Input = modal.find('.kau-2')
          var modalExtraInput = modal.find('.extra')

          // Выставляем значения из редактируемой строки
          modalAccountInput.val(rowAccountInput.val())
          modalKAU1Input.val(rowKAU1Input.val())
          modalKAU2Input.val(rowKAU2Input.val())
          modalExtraInput.val(rowExtraInput.val())

          if (itemType == 3) {
            // Получаем специфические поля ввода из редактируемой строки
            var rowBankCommissionInput = editRow.find('.bank-commission')
            var rowService1SumRubInput = editRow.find('.service-1-sum-rub')
            var rowService1SumVATInput = editRow.find('.service-1-sum-vat')
            var rowService2SumRubInput = editRow.find('.service-2-sum-rub')
            var rowService2SumVATInput = editRow.find('.service-2-sum-vat')

            // Получаем поля ввода на модальной форме
            var modalBankCommissionInput = modal.find('.bank-commission')
            var modalService1SumRubInput = modal.find('.service-1-sum-rub')
            var modalService1SumVATInput = modal.find('.service-1-sum-vat')
            var modalService2SumRubInput = modal.find('.service-2-sum-rub')
            var modalService2SumVATInput = modal.find('.service-2-sum-vat')
    
            // Выставляем значения из редактируемой строки
            modalBankCommissionInput.val(rowBankCommissionInput.val())
            modalService1SumRubInput.val(rowService1SumRubInput.val())
            modalService1SumVATInput.val(rowService1SumVATInput.val())
            modalService2SumRubInput.val(rowService2SumRubInput.val())
            modalService2SumVATInput.val(rowService2SumVATInput.val())
          }
        }
        // Оплата заказ-наряда
        else if (itemType == 5) {
          // Получаем специфические поля ввода из редактируемой строки
          var rowMaterialSumInput = editRow.find('.material-sum')
          var rowMaterialVATInput = editRow.find('.material-vat')
          var rowOilSumInput = editRow.find('.oil-sum')
          var rowOilVATInput = editRow.find('.oil-vat')
          var rowPartSumInput = editRow.find('.part-sum')
          var rowPartVATInput = editRow.find('.part-vat')
          var rowServiceSumInput = editRow.find('.service-sum')
          var rowServiceVATInput = editRow.find('.service-vat')
          var rowRouteInput = editRow.find('.route')

          // Получаем поля ввода на модальной форме
          var modalMaterialSumInput = modal.find('.material-sum')
          var modalMaterialVATInput = modal.find('.material-vat')
          var modalOilSumInput = modal.find('.oil-sum')
          var modalOilVATInput = modal.find('.oil-vat')
          var modalPartSumInput = modal.find('.part-sum')
          var modalPartVATInput = modal.find('.part-vat')
          var modalServiceSumInput = modal.find('.service-sum')
          var modalServiceVATInput = modal.find('.service-vat')
          var modalRouteInput = modal.find('.route')

          const materialSum = parseFloat(rowMaterialSumInput.val().replace(/,/g, '.')) || 0
          const oilSum = parseFloat(rowOilSumInput.val().replace(/,/g, '.')) || 0
          const partSum = parseFloat(rowPartSumInput.val().replace(/,/g, '.')) || 0
          const serviceSum = parseFloat(rowServiceSumInput.val().replace(/,/g, '.')) || 0

          const materialVAT = parseFloat(rowMaterialVATInput.val().replace(/,/g, '.')) || 0
          const oilVAT = parseFloat(rowOilVATInput.val().replace(/,/g, '.')) || 0
          const partVAT = parseFloat(rowPartVATInput.val().replace(/,/g, '.')) || 0
          const serviceVAT = parseFloat(rowServiceVATInput.val().replace(/,/g, '.')) || 0

          if (materialSum > 0 || oilSum > 0 || partSum > 0 || serviceSum > 0){
            modalExpenseSumRubInput.val((materialSum + oilSum + partSum + serviceSum).toFixed(2))
            modalExpenseSumVATInput.val((materialVAT + oilVAT + partVAT + serviceVAT).toFixed(2))
          }

          // Выставляем значения из редактируемой строки
          modalMaterialSumInput.val(rowMaterialSumInput.val())
          modalMaterialVATInput.val(rowMaterialVATInput.val())
          modalOilSumInput.val(rowOilSumInput.val())
          modalOilVATInput.val(rowOilVATInput.val())
          modalPartSumInput.val(rowPartSumInput.val())
          modalPartVATInput.val(rowPartVATInput.val())
          modalServiceSumInput.val(rowServiceSumInput.val())
          modalServiceVATInput.val(rowServiceVATInput.val())
          modalRouteInput.val(rowRouteInput.val())
        }
      })

      // Принятие изменений из модальных форм
      $('.inventoryModal, #serviceModal, #presentationModal, #purchaseOrderModal').on('click', '.ok-button', function(e){
        var modal = $(e.delegateTarget)
        const itemType = editRow.find('input.item-type').val()

        // Получаем общие поля ввода из редактируемой строки
        var rowDocumentSelect = editRow.find('select.approve-doc')
        var rowDocNumInput = editRow.find('.doc-num')
        var rowDocDateInput = editRow.find('.doc-date')
        var rowExpenseSumRubInput = editRow.find('.expense-sum-rub')
        var rowExpenseSumVATInput = editRow.find('.expense-sum-vat')
        var rowSypherNumInput = editRow.find('.sypher-num')
        var rowSypherDateInput = editRow.find('.sypher-date')
        var rowCommentInput = editRow.find('.comment')

        // Получаем поля ввода на модальной форме
        var modalDocumentSelect = modal.find('select.approve-doc')
        var modalDocNumInput = modal.find('.doc-num')
        var modalDocDateInput = modal.find('.doc-date')
        var modalExpenseSumRubInput = modal.find('.expense-sum-rub')
        var modalExpenseSumVATInput = modal.find('.expense-sum-vat')
        var modalSypherNumInput = modal.find('.sypher-num')
        var modalSypherDateInput = modal.find('.sypher-date')
        var modalCommentInput = modal.find('.comment')

        // Выставляем значения из формы в строку
        rowDocumentSelect.val(modalDocumentSelect.val())
        rowDocNumInput.val(modalDocNumInput.val())
        rowDocDateInput.val(modalDocDateInput.val())

        rowExpenseSumRubInput.val(modalExpenseSumRubInput.val())
        rowExpenseSumVATInput.val(modalExpenseSumVATInput.val())

        rowSypherNumInput.val(modalSypherNumInput.val())
        rowSypherDateInput.val(modalSypherDateInput.val())
        rowCommentInput.val(modalCommentInput.val())

        // Приобретение ТМЦ
        if (itemType == 2) {
          // Получаем специфические поля ввода из редактируемой строки
          var rowRouteInput = editRow.find('.route')

          // Получаем поля ввода на модальной форме
          var modalRouteInput = modal.find('.route')

          // Выставляем значения из формы в строку
          rowRouteInput.val(modalRouteInput.val())
        }
        // Оплата работ, услуг, Представительские расходы
        else if (itemType == 3 || itemType == 4) {
          // Получаем специфические поля ввода из редактируемой строки
          var rowAccountInput = editRow.find('.account')
          var rowKAU1Input = editRow.find('.kau-1')
          var rowKAU2Input = editRow.find('.kau-2')
          var rowExtraInput = editRow.find('.extra')

          // Получаем поля ввода на модальной форме
          var modalAccountInput = modal.find('.account')
          var modalKAU1Input = modal.find('.kau-1')
          var modalKAU2Input = modal.find('.kau-2')
          var modalExtraInput = modal.find('.extra')

          // Выставляем значения из формы в строку
          rowAccountInput.val(modalAccountInput.val())
          rowKAU1Input.val(modalKAU1Input.val())
          rowKAU2Input.val(modalKAU2Input.val())
          rowExtraInput.val(modalExtraInput.val())

          if (itemType == 3) {
            var rowBankCommissionInput = editRow.find('.bank-commission')
            var rowService1SumRubInput = editRow.find('.service-1-sum-rub')
            var rowService1SumVATInput = editRow.find('.service-1-sum-vat')
            var rowService2SumRubInput = editRow.find('.service-2-sum-rub')
            var rowService2SumVATInput = editRow.find('.service-2-sum-vat')

            // Получаем поля ввода на модальной форме
            var modalBankCommissionInput = modal.find('.bank-commission')
            var modalService1SumRubInput = modal.find('.service-1-sum-rub')
            var modalService1SumVATInput = modal.find('.service-1-sum-vat')
            var modalService2SumRubInput = modal.find('.service-2-sum-rub')
            var modalService2SumVATInput = modal.find('.service-2-sum-vat')
    
          
            const sum1 = parseFloat(modalService1SumRubInput.val().replace(/,/g, '.')) || 0
            const sum2 = parseFloat(modalService2SumRubInput.val().replace(/,/g, '.')) || 0
            const total = parseFloat(modalExpenseSumRubInput.val().replace(/,/g, '.')) || 0

            if ((total !== sum1 + sum2) && (sum1 > 0 || sum2 > 0)) {
              alert('Неправильно разделена общая сумма по документу!');
              e.stopImmediatePropagation();
              return
            }
            
            // Выставляем значения из формы в строку
            rowBankCommissionInput.val(modalBankCommissionInput.val())
            rowService1SumRubInput.val(modalService1SumRubInput.val())
            rowService1SumVATInput.val(modalService1SumVATInput.val())
            rowService2SumRubInput.val(modalService2SumRubInput.val())
            rowService2SumVATInput.val(modalService2SumVATInput.val())
          }
        }
        // Оплата заказ-наряда
        else if (itemType == 5) {
          // Получаем специфические поля ввода из редактируемой строки
          var rowMaterialSumInput = editRow.find('.material-sum')
          var rowMaterialVATInput = editRow.find('.material-vat')
          var rowOilSumInput = editRow.find('.oil-sum')
          var rowOilVATInput = editRow.find('.oil-vat')
          var rowPartSumInput = editRow.find('.part-sum')
          var rowPartVATInput = editRow.find('.part-vat')
          var rowServiceSumInput = editRow.find('.service-sum')
          var rowServiceVATInput = editRow.find('.service-vat')
          var rowRouteInput = editRow.find('.route')

          // Получаем поля ввода на модальной форме
          var modalMaterialSumInput = modal.find('.material-sum')
          var modalMaterialVATInput = modal.find('.material-vat')
          var modalOilSumInput = modal.find('.oil-sum')
          var modalOilVATInput = modal.find('.oil-vat')
          var modalPartSumInput = modal.find('.part-sum')
          var modalPartVATInput = modal.find('.part-vat')
          var modalServiceSumInput = modal.find('.service-sum')
          var modalServiceVATInput = modal.find('.service-vat')
          var modalRouteInput = modal.find('.route')

          const materialSum = parseFloat(modalMaterialSumInput.val().replace(/,/g, '.')) || 0
          const oilSum = parseFloat(modalOilSumInput.val().replace(/,/g, '.')) || 0
          const partSum = parseFloat(modalPartSumInput.val().replace(/,/g, '.')) || 0
          const serviceSum = parseFloat(modalServiceSumInput.val().replace(/,/g, '.')) || 0

          const materialVAT = parseFloat(modalMaterialVATInput.val().replace(/,/g, '.')) || 0
          const oilVAT= parseFloat(modalOilVATInput.val().replace(/,/g, '.')) || 0
          const partVAT = parseFloat(modalPartVATInput.val().replace(/,/g, '.')) || 0
          const serviceVAT = parseFloat(modalServiceVATInput.val().replace(/,/g, '.')) || 0

          const total = parseFloat(modalExpenseSumRubInput.val().replace(/,/g, '.')) || 0

          if ((total.toFixed(2) !== (materialSum + oilSum + partSum + serviceSum).toFixed(2)) && 
          (modalMaterialSumInput.val() || modalOilSumInput.val() || modalPartSumInput.val() || modalServiceSumInput.val())) {
            alert('Неправильно разделена общая сумма по документу!');
            e.stopImmediatePropagation();
            return
          }

          // Выставляем значения из формы в строку
          rowMaterialSumInput.val(modalMaterialSumInput.val())
          rowMaterialVATInput.val(modalMaterialVATInput.val())
          rowOilSumInput.val(modalOilSumInput.val())
          rowOilVATInput.val(modalOilVATInput.val())
          rowPartSumInput.val(modalPartSumInput.val())
          rowPartVATInput.val(modalPartVATInput.val())
          rowServiceSumInput.val(modalServiceSumInput.val())
          rowServiceVATInput.val(modalServiceVATInput.val())
          rowRouteInput.val(modalRouteInput.val())

          //rowExpenseSumRubInput.val((materialSum + oilSum + partSum + serviceSum).toFixed(2))
          //rowExpenseSumVATInput.val((materialSum + oilSum + partSum + serviceSum).toFixed(2))

          if (materialSum > 0 || oilSum > 0 || partSum > 0 || serviceSum > 0){
            $('#action').val('split-' + editRow.attr('id'))
            $('form').submit()
          }
        }
      })
    })

    // Событие прикрепления файла
    $('.form-control-file').on('change', function(e) {
      const file = e.target.files[0]
      if (file) {
        const row = $(e.target).closest('tr')
        const fileNameInput = row.find('input.file-name')
        const fileDateInput = row.find('input.file-date')

        fileNameInput.val(file.name)
        fileDateInput.val(new Date().toLocaleDateString("ru-RU"))
      }
    })

    var activeTab = document.querySelector('.tab-pane.show.active')
    updateTotal(activeTab)
  </script>
{% endblock %}
