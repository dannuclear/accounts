{% extends 'main/base.html' %}

{% block title %}
  Авансовый отчет
{% endblock %}

{% block content %}
  <style rel="stylesheet" type="text/css">
    .nav-link {
      padding: 0.1rem 0.5rem;
    }
    .col-num-row td{
      padding: 0;
    }
  </style>

  <form id="mainForm" method="post" class="container-fluid" enctype="multipart/form-data">
    {% csrf_token %}

    <div class="form-row align-items-center">
      <div class="col-12 p-1 text-right">
        {% if lockLevel < 2 %}
          <input type="submit" class="btn btn-success btn-sm" value="Сохранить" />
        {% endif %}
        <a href="{% url 'advanceReports' %}?imprestAccount={{ form.instance.imprestAccount.account }}" class="btn btn-danger btn-sm">Отмена</a>
      </div>
    </div>

    {{ form.errors }}
    {{ form.non_field_errors }}
    {% comment %} {{ travelExpenses.errors }}
    {{ travelExpenses.non_field_errors }}
    {{ orgServices.errors }}
    {{ orgServices.non_field_errors }}
    {{ iventoryItems.errors }}
    {{ iventoryItems.non_field_errors }}
    {{ services.errors }}
    {{ services.non_field_errors }}
    {{ presentationExpenses.errors }}
    {{ presentationExpenses.non_field_errors }}
    {{ purchaseOrderExpenses.errors }}
    {{ purchaseOrderExpenses.non_field_errors }}
    {{ attachments.errors }}
    {{ attachments.non_field_errors }} {% endcomment %}

    <input type="hidden" name="id" value="{{ form.id.value }}" />
    <input id="mission-days" type="hidden" value="{{ form.instance.days|default_if_none:'' }}" />

    <input id="action" type="hidden" name="action">
    <input type="hidden" class="approve-date" name="{{ form.approveDate.name }}" value="{{ form.approveDate.value|default_if_none:'' }}" />
    <input type="hidden" class="approve-action-date" name="{{ form.approveActionDate.name }}" value="{{ form.approveActionDate.value|default_if_none:'' }}" />
    <input type="hidden" name="lockLevel" value="{{ lockLevel|default_if_none:'0' }}" />

    <div class="form-row border rounded mt-1">
      <div class="col-xl-3 col-md-3 p-1 text-center">
        <h4 class="m-0 border rounded">Авансовый отчет <a href="{% url 'prepayments' %}/{{ form.instance.id }}" title="Перейти в выданный под отчет аванс"><i class="fa-light fa-money-bill-transfer"></i></a></h4>
      </div>

      <div class="col-xl-2 col-md-3 p-1 input-group input-group-sm">
        <div class="input-group-prepend">
          <span class="input-group-text">{{ form.reportNum.label }}</span>
        </div>
        <input type="text" class="mb-0 form-control form-control-sm {% if form.reportNum.errors %} is-invalid {% endif %}" value="{{ form.instance.reportNum|default_if_none:'' }}" readonly /> {% comment %}name="{{ form.reportNum.name }}"{% endcomment %}
      </div>

      <div class="col-xl-2 col-md-3 p-1 input-group input-group-sm">
        <div class="input-group-prepend">
          <span class="input-group-text">{{ form.reportDate.label }}</span>
        </div>
        <input type="text" class="text-center mb-0 form-control form-control-sm {% if form.reportDate.errors %} is-invalid {% endif %}" value="{{ form.instance.reportDate|default_if_none:'' }}" readonly /> {% comment %}name="{{ form.reportDate.name }}"{% endcomment %}
      </div>

      <div class="col-xl-2 w-0 p-0 flex-md-shrink-1"></div>

      <div class="col-xl-3 col-md-3 p-1 input-group input-group-sm">
        <div class="input-group-prepend">
          <span class="input-group-text {% if form.reportStatus.errors %} bg-danger {% endif %}">{{ form.reportStatus.label }}</span>
        </div>
        {{ form.reportStatus }}
      </div>
    </div>

    <div class="form-row border rounded mt-1 p-1">
      <div class="col-12 pl-0">
        <div class="row container-fluid">
          <div class="col-2 border text-left">
            <h6 class="align-middle d-inline m-0">Структурное подразделение*</h6>
          </div>
          <div class="col-3 border p-1 input-group input-group-sm">
            <textarea id="emp-div-name" rows="1" class="text-center mb-0 form-control form-control-sm {% if form.empDivName.errors %} is-invalid {% endif %}" name="{{ form.empDivName.name }}" style="resize: none;">{{ form.empDivName.value|default_if_none:'' }}</textarea>
            <div class="input-group-append">
              <button id="div-search" class="btn btn-outline-secondary" type="button"><i class="fa-light fa-magnifying-glass"></i></button>
            </div>
          </div>
          <div class="col-1 d-flex">
            <div class="row align-content-stretch">
              <div class="col-12 text-center border">код*</div>
              <div class="col-12 text-center border p-1">
                <input id="emp-div-num" type="text" class="text-center mb-0 form-control form-control-sm p-0" value="{{ form.instance.empDivNum|default_if_none:''|stringformat:'03d' }}" readonly style="height: 20px;" />
              </div>
            </div>
          </div>

          <div class="col-3 input-group input-group-sm">
            <div class="input-group-prepend">
              <span class="input-group-text">{{ form.reportAccountingNum.label }}</span>
            </div>
            <input class="mb-0 form-control form-control-sm h-auto d-flex align-items-end justify-content-center {% if form.reportAccountingNum.errors %} is-invalid {% endif %}" name="{{ form.reportAccountingNum.name }}" value="{{ form.reportAccountingNum.value|default_if_none:'' }}" />
          </div>
        </div>
      </div>
    </div>

    <div class="form-row border rounded mt-1">
      <div class="col-sm-6 col-xl-4 p-1 input-group input-group-sm">
        <div class="input-group-prepend">
          <span class="input-group-text">Подотчетное лицо*</span>
        </div>
        <input id="emp-full-name" type="text" class="mb-0 form-control form-control-sm" value="{{ form.instance.empFullName|default_if_none:'' }}" readonly />
      </div>

      <div class="col-sm-6 col-xl-3 p-1 input-group input-group-sm">
        <div class="input-group-prepend">
          <span class="input-group-text">Табельный номер</span>
        </div>
        <input id="emp-num-input" type="text" class="text-center mb-0 form-control form-control-sm" value="{{ form.instance.empNum|default_if_none:'' }}" readonly />
      </div>

      <div class="col-sm-6 col-xl-5 p-1 input-group input-group-sm">
        <div class="input-group-prepend">
          <span class="input-group-text">Должность</span>
        </div>
        <input id="emp-prof-name" type="text" class="mb-0 form-control form-control-sm" value="{{ form.instance.empProfName|default_if_none:'' }}" readonly />
      </div>

      <div class="col-sm-6 col-xl-4 p-1 input-group input-group-sm">
        <div class="input-group-prepend">
          <span class="input-group-text">Телефон</span>
        </div>
        <input type="text" class="mb-0 form-control form-control-sm" name="{{ form.phone.name }}" value="{{ form.phone.value|default_if_none:'' }}" />
      </div>
    </div>

    <div class="form-row border rounded mt-1">
      <div class="col-sm-12 p-1 input-group input-group-sm">
        <div class="input-group-prepend">
          <span class="input-group-text">Назначение аванса*</span>
        </div>
        <input type="text" class="mb-0 form-control form-control-sm" value="{{ form.instance.prepaidDestList|default_if_none:'' }}" readonly />
      </div>
    </div>

    <div class="form-row border rounded mt-1">
      <div class="col-sm-3 col-xl-3 p-1 input-group input-group-sm">
        <div class="input-group-prepend">
          <span class="input-group-text text-left">Идентификатор <br />государственного<br />контракта</span>
        </div>
        <input type="text" class="mb-0 form-control form-control-sm h-auto d-flex align-items-end justify-content-center" name="{{ form.contractIdentifier.name }}" value="{{ form.contractIdentifier.value|default_if_none:'' }}" />
      </div>

      <div class="col-sm-2 col-xl-2 p-1 input-group input-group-sm">
        <div class="input-group-prepend">
          <span class="input-group-text">Приказ</span>
        </div>
        <span class="mb-0 form-control form-control-sm h-auto d-flex align-items-end justify-content-center" readonly>{% if form.instance.document_id == 14 %}{{ form.instance.docNum }}{% endif %}</span>
      </div>

      <div class="col-sm-4 col-xl-4 p-1 input-group input-group-sm">
        <div class="input-group-prepend">
          <span class="input-group-text text-left">Номер заявки в ЕОСДО,<br />заявления, ЭД</span>
        </div>
        <span class="mb-0 form-control form-control-sm h-auto d-flex align-items-end justify-content-center" readonly>{% if form.instance.document_id == 5 %}{{ form.instance.docNum }}{% endif %}</span>
        {% if form.instance.request_id %}
          <div class="input-group-append">
            <a class="btn btn-outline-primary d-flex align-items-center" href="{% url 'requests' %}/{{ form.instance.request_id }}" title="Перейти в заявку"><i class="fa-light fa-file-signature"></i></a>
          </div>
        {% endif %}
      </div>

      <div class="col-sm-3 col-xl-3 p-1 input-group input-group-sm">
        <div class="input-group-prepend">
          <span class="input-group-text">Дата документа</span>
        </div>
        <span class="mb-0 form-control form-control-sm h-auto text-center d-flex align-items-end justify-content-center" readonly>{{ form.instance.docDate }}</span>
      </div>
    </div>

    <div class="form-row border rounded mt-1">
      <div class="col-sm-3 col-xl-3 p-1 input-group input-group-sm">
        <div class="input-group-prepend">
          <span class="input-group-text text-left" style="font-size: 0.7em;">A.I. Получен аванс подотчетным<br />лицом, руб. коп.:</span>
        </div>
        <input id="total-sum" type="text" class="mb-0 form-control form-control-sm h-auto {% if form.totalSum.errors %} is-invalid {% endif %}" name="{{ form.totalSum.name }}" value="{{ form.instance.totalSum|default_if_none:'' }}" readonly />
      </div>

      <div class="col-sm-2 col-xl-2 p-1 input-group input-group-sm">
        <div class="input-group-prepend">
          <span class="input-group-text" style="font-size: 0.7em;">A.II. Израсходовано<br />всего, руб. коп.:</span>
        </div>
        <input id="spended-sum" type="text" class="mb-0 form-control form-control-sm h-auto {% if form.spendedSum.errors %} is-invalid {% endif %}" value="{{ form.spendedSum.value|default_if_none:'' }}" readonly title="Расчитывается автоматически после сохранения" /> {% comment %}name="{{ form.spendedSum.name }}"{% endcomment %}
      </div>

      <div class="col-sm-4 col-xl-4 p-1 input-group input-group-sm">
        <div class="input-group-prepend">
          <span class="input-group-text text-left" style="font-size: 0.7em;">A.III. Остаток/перерасход по авансу,<br />полученному подотчетным лицом, руб. коп.:</span>
        </div>
        <input id="dif-sum" type="text" class="mb-0 form-control form-control-sm h-auto" readonly />
        <div class="input-group-append">
          <button id="distrib-button" type="button" class="btn btn-outline-primary" data-toggle="modal" data-target="#distribModal">Распределить</button>
        </div>
      </div>

      <div class="col-sm-3 col-xl-3 p-1 input-group input-group-sm">
        <div class="input-group-prepend">
          <span class="input-group-text" style="font-size: 0.7em;">Сумма по бухгалтерской<br />справке</span>
        </div>
        <input type="text" class="mb-0 form-control form-control-sm h-auto {% if form.reportAccountingSum.errors %} is-invalid {% endif %}" name="{{ form.reportAccountingSum.name }}" value="{{ form.reportAccountingSum.value|default_if_none:'' }}" />
      </div>
    </div>

    {% if form.instance.reportStatus_id == 3 %}
      <div class="form-row border rounded mt-1 p-1">
        {% if lockLevel == 1 %}
          <button class="btn btn-sm btn-outline-primary mr-1 unlock">Корректировка проводки</button>
        {% endif %}
        {% if lockLevel == 0 %}
          <button type="button" class="btn btn-sm btn-outline-primary mr-1" data-toggle="modal" data-target="#approveModal">Подтвердить проводки</button>
        {% endif %}
        {% comment %} <button type="button" class="btn btn-sm btn-outline-primary mr-1" data-toggle="modal" data-target="">Печать авансового отчета</button> {% endcomment %}
      </div>
    {% endif %}

    <div class="form-row border rounded mt-1 p-1">
      <div class="w-100">
        <ul class="nav nav-tabs w-100" id="myTab" role="tablist" style="font-size: 0.8em;">
          {% if form.instance.imprestAccount_id != 7104 and form.instance.imprestAccount_id != 7106 %}
            <li class="nav-item" role="presentation">
              <button class="nav-link active h-100" id="tab-1" data-toggle="tab" data-target="#tab-content-1" type="button" role="tab" aria-controls="tab-content-1" aria-selected="true">Командировочные расходы</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link h-100" id="tab-2" data-toggle="tab" data-target="#tab-content-2" type="button" role="tab" aria-controls="tab-content-2" aria-selected="false">Расходы, оплаченные организацией за услуги проезда,<br />проживания подотчетного лица и пр.услуги</button>
            </li>
          {% endif %}
          <li class="nav-item" role="presentation">
            <button class="nav-link h-100 {% if form.instance.imprestAccount_id == 7104 or form.instance.imprestAccount_id == 7106 %} active {% endif %}" id="tab-3" data-toggle="tab" data-target="#tab-content-3" type="button" role="tab" aria-controls="tab-content-3" aria-selected="false">Приобретение ТМЦ</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link h-100" id="tab-4" data-toggle="tab" data-target="#tab-content-4" type="button" role="tab" aria-controls="tab-content-4" aria-selected="false">Оплата работ, услуг</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link h-100" id="tab-5" data-toggle="tab" data-target="#tab-content-5" type="button" role="tab" aria-controls="tab-content-5" aria-selected="false">Представительские расходы</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link h-100" id="tab-6" data-toggle="tab" data-target="#tab-content-6" type="button" role="tab" aria-controls="tab-content-6" aria-selected="false">Оплата заказ-наряда</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link h-100" id="tab-7" data-toggle="tab" data-target="#tab-content-7" type="button" role="tab" aria-controls="tab-content-7" aria-selected="false">Приложение</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link h-100" id="tab-8" data-toggle="tab" data-target="#tab-content-8" type="button" role="tab" aria-controls="tab-content-8" aria-selected="false">Сообщение</button>
          </li>
        </ul>
        <div class="tab-content border" id="tabContent">
          {% if form.instance.imprestAccount_id != 7104 and form.instance.imprestAccount_id != 7106 %}
            <div class="tab-pane fade show active container-fluid" id="tab-content-1" role="tabpanel" aria-labelledby="tab-1">
              <div class="row p-1">
                {% if not lockLevel %}
                  <button class="btn btn-sm btn-outline-primary btn-add-row" data-prefix="{{ travelExpenses.prefix }}">Добавить</button>
                {% endif %}
              </div>

              <div class="row p-1">
                {% include 'advanceReport/itemTable.html' with items=travelExpenses itemType=0 accounting=True %}
              </div>
            </div>

            <div class="tab-pane fade container-fluid" id="tab-content-2" role="tabpanel" aria-labelledby="tab-2">
              <div class="row p-1">
                {% if not lockLevel %}
                  <button class="btn btn-sm btn-outline-primary btn-add-row" data-prefix="{{ orgServices.prefix }}">Добавить</button>
                {% endif %}
              </div>

              <div class="row p-1">
                {% include 'advanceReport/itemTable.html' with items=orgServices itemType=1 %}
              </div>
            </div>
          {% endif %}

          <div class="tab-pane fade container-fluid {% if form.instance.imprestAccount_id == 7104 or form.instance.imprestAccount_id == 7106 %} show active {% endif %}" id="tab-content-3" role="tabpanel" aria-labelledby="tab-3">
            <div class="row p-1">
              {% if not lockLevel %}
                <button class="btn btn-sm btn-outline-primary btn-add-row" data-prefix="{{ iventoryItems.prefix }}">Добавить</button>
              {% endif %}
            </div>

            <div class="row p-1">
              {% include 'advanceReport/itemTable.html' with items=iventoryItems itemType=2 accounting=True %}
            </div>
          </div>
          <div class="tab-pane fade container-fluid" id="tab-content-4" role="tabpanel" aria-labelledby="tab-4">
            <div class="row p-1">
              {% if not lockLevel %}
                <button class="btn btn-sm btn-outline-primary btn-add-row" data-prefix="{{ services.prefix }}">Добавить</button>
              {% endif %}
            </div>

            <div class="row p-1">
              {% include 'advanceReport/itemTable.html' with items=services itemType=3 %}
            </div>
          </div>
          <div class="tab-pane fade container-fluid" id="tab-content-5" role="tabpanel" aria-labelledby="tab-5">
            <div class="row p-1">
              {% if not lockLevel %}
                <button class="btn btn-sm btn-outline-primary btn-add-row" data-prefix="{{ presentationExpenses.prefix }}">Добавить</button>
              {% endif %}
            </div>

            <div class="row p-1">
              {% include 'advanceReport/itemTable.html' with items=presentationExpenses itemType=4 %}
            </div>
          </div>
          <div class="tab-pane fade container-fluid" id="tab-content-6" role="tabpanel" aria-labelledby="tab-6">
            <div class="row p-1">
              {% if not lockLevel %}
                <button class="btn btn-sm btn-outline-primary btn-add-row" data-prefix="{{ purchaseOrderExpenses.prefix }}">Добавить</button>
              {% endif %}
            </div>

            <div class="row p-1">
              {% include 'advanceReport/itemTable.html' with items=purchaseOrderExpenses itemType=5 %}
            </div>
          </div>
          <div class="tab-pane fade container-fluid" id="tab-content-7" role="tabpanel" aria-labelledby="tab-7">
            <div class="row p-1">
              {% if not lockLevel %}
                <button type="button" class="btn btn-sm btn-outline-primary btn-add-row" data-prefix="{{ attachments.prefix }}">Добавить</button>
              {% endif %}
            </div>

            <div class="row p-1">
              <table class="table table-bordered table-sm text-center">
                <thead>
                  <th>Наименование</th>
                  <th width="10%">Дата прикрепления</th>
                  <th>Просмотр</th>
                  <th width="40%">Загрузить</th>
                  <th width="3%"></th>
                </thead>
                <tbody class="{{ attachments.prefix }}-container">
                  {{ attachments.management_form }}
                  {% for attachment in attachments %}
                    <tr class="{{ attachments.prefix }}-form">
                      {{ attachment.id }}
                      <input type="hidden" name="{{ attachment.DELETE.html_name }}" id="{{ attachment.DELETE.auto_id }}" />
                      <td>
                        <input type="text" class="form-control form-control-sm file-name" name="{{ attachment.name.html_name }}" value="{{ attachment.name.value|default_if_none:'' }}" autocomplete="off" />
                      </td>
                      <td>
                        <input type="text" class="form-control form-control-sm datepeeker file-date" name="{{ attachment.date.html_name }}" value="{{ attachment.date.value|default_if_none:'' }}" autocomplete="off" />
                      </td>
                      <td>
                        {% if attachment.file.value is not None %}
                          <a href="{{ attachment.file.value.url }}" target="__blank" title="{{ attachment.file.value }}">Просмотр</a>
                        {% endif %}
                      </td>
                      <td>
                        <input type="file" name="{{ attachment.file.html_name }}" class="form-control-file" />
                      </td>
                      <td>
                        <button type="button" class="btn btn-sm btn-outline-danger row-delete"><i class="fa-light fa-trash"></i></button>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
          <div class="tab-pane fade container-fluid" id="tab-content-8" role="tabpanel" aria-labelledby="tab-8">
            <div class="row">
              <div class="col-12 p-1 input-group input-group-sm">
                <div class="input-group-prepend">
                  <span class="input-group-text">Примечание</span>
                </div>
                <textarea class="mb-0 form-control form-control-sm {% if form.reportComment.errors %} is-invalid {% endif %}" name="{{ form.reportComment.name }}">{{ form.reportComment.value|default_if_none:'' }}</textarea>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="distribModal" tabindex="-1" role="dialog" aria-labelledby="distribModalTitle" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLongTitle">Распределить остаток</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          </div>
          <div class="modal-body container-fluid">
            <div class="row p-1">
              <div class="col-2">Остаток сумме</div>
              <div class="col-2">
                <input type="text" class="mb-0 form-control form-control-sm" name="{{ form.distribSalary.name }}" value="{{ form.distribSalary.value|default_if_none:'' }}" />
              </div>
              <div class="col">Внесен в массив удержаний из зарплаты за</div>
              <div class="col-3">
                <input type="text" class="mb-0 form-control form-control-sm datepeeker" name="{{ form.distribSalaryDate.name }}" value="{{ form.distribSalaryDate.value|default_if_none:'' }}" />
              </div>
            </div>

            <div class="row p-1">
              <div class="col-2"></div>
              <div class="col-2">
                <input type="text" class="mb-0 form-control form-control-sm" name="{{ form.distribBank.name }}" value="{{ form.distribBank.value|default_if_none:'' }}" />
              </div>
              <div class="col">(перерасход) перечислен на карту банка</div>
              <div class="col-3">{{ form.distribBankMethod }}</div>
            </div>

            <div class="row p-1">
              <div class="col-2"></div>
              <div class="col-2">
                <input type="text" class="mb-0 form-control form-control-sm" name="{{ form.distribCarryover.name }}" value="{{ form.distribCarryover.value|default_if_none:'' }}" />
              </div>
              <div class="col">переходящий остаток. Номер А.О.:</div>
              <div class="col-3">
                <input type="text" class="mb-0 form-control form-control-sm" name="{{ form.distribCarryoverReportNum.name }}" value="{{ form.distribCarryoverReportNum.value|default_if_none:'' }}" />
              </div>
            </div>
          </div>
          <div class="modal-footer">
            {% comment %} <button type="button" class="btn btn-secondary" data-dismiss="modal">Отмена</button> {% endcomment %}
            <button type="button" class="btn btn-primary" data-dismiss="modal">Ок</button>
          </div>
        </div>
      </div>
    </div>
  </form>

  <div class="modal fade" id="approveModal" tabindex="-1" role="dialog" aria-labelledby="approveModalTitle" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLongTitle">Подтвердить проводки</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        </div>
        <div class="modal-body container-fluid">
          <div class="row p-1">
            <div class="col-12 input-group input-group-sm">
              <div class="input-group-prepend">
                <span class="input-group-text">Дата согласования</span>
              </div>
              <input type="text" class="mb-0 form-control form-control-sm datepeeker approve-date" />
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Отмена</button>
          <button type="submit" form="mainForm" class="btn btn-primary ok-button">Ок</button>
        </div>
      </div>
    </div>
  </div>

  {% comment %} {% include 'advanceReport/inventoryModal.html' %} {% endcomment %}

  {% include 'advanceReport/serviceModal.html' %}

  {% include 'advanceReport/presentationModal.html' %}

  {% include 'advanceReport/purchaseOrderModal.html' %}

  <script type="text/javascript">
    var editRow

    function updateTotal (tabDiv) {
      var sum_currency = 0, sum_rub = 0, sum_vat = 0, accounting_sum = 0;
      $(tabDiv).find('input.expense-sum, input.accounting-sum').each(function(){
        if (this.value)
          if (this.classList.contains("expense-sum-currency"))
            sum_currency += parseFloat(this.value)
          else if (this.classList.contains("expense-sum-rub"))
            sum_rub += parseFloat(this.value)
          else if (this.classList.contains("expense-sum-vat"))
            sum_vat += parseFloat(this.value)
          else if (this.classList.contains("accounting-sum"))
            accounting_sum += parseFloat(this.value)
      });
      $(tabDiv).find('.expense-sum-currency-total').text(sum_currency)
      $(tabDiv).find('.expense-sum-rub-total').text(sum_rub)
      $(tabDiv).find('.expense-sum-vat-total').text(sum_vat)
      $(tabDiv).find('.accounting-sum-total').text(accounting_sum)
      $(tabDiv).find('.accounting-diff-total').text(sum_rub - accounting_sum)
    }

    $(document).ready(function () {
      $('#button-add-item').on('click', function (e) {
        addForm('item')
      })
    
      window.location.hash && $(window.location.hash).tab('show');

      $('.nav-tabs button').click(function (e) {
        window.location.hash = e.target.id;
      });

      // При показе таба обновляем итоги
      $('button[data-toggle="tab"]').on('shown.bs.tab', function (e) {
        //console.log(e.target)
        //console.log(e.relatedTarget)
        updateTotal($(e.target.dataset.target))
      })

      // Добавить элемент авансового отчета
      $('.btn-add-row, .btn-add-entity-row').on('click', function (e) {
        $('#action').val('add-' + $(e.target).data('prefix'))
        //const form = addForm($(e.target).data('prefix'))
        //$(form).find('.datepeeker').removeAttr('id').removeClass('hasDatepicker').datepicker()
      })

      // Удалить элемент авансового отчета
      $('.btn-delete-row').on('click', function (e) {
        $('#action').val('delete-' + $(e.currentTarget).data('prefix'))
      })

      // Заполнить элемент авансового отчета
      $('.btn-fill-entity-row').on('click', function (e) {
        $('#action').val('fill-' + $(e.currentTarget).data('prefix'))
      })
    
      $('tbody').on('click', '.row-delete', function (e) {
        const tr = $(e.currentTarget).closest('tr')
        $('.'+tr.attr('id')).hide()
        tr.hide()
        tr.find("[id$='DELETE']").val(1)
      })
    
      $('.datepeeker').datepicker({
        beforeShow: function() {
          setTimeout(function(){
              $('.ui-datepicker').css('z-index', 99999999999999);
          }, 0);
        }
      })
    
      $('#div-search').on('click', function (e) {
        const divNum = $('#emp-div-num').val()
        if (!divNum) {
          alert('Введите номер подразделения')
          return
        }
        $.get(`/api/v1/departments/${divNum}/?format=json`, function (data) {
          if (data) {
            $('#emp-div-name').val(data.name)
          } else {
            $('#emp-div-name').val('')
          }
        }).fail(function (e) {
          $('#emp-div-name').val('')
        })
      })
    
      $('#spended-sum').on('change', function (e) {
        const spended = $(this).val()
        const received = $('#total-sum').val()
    
        $('#dif-sum').val(stringDif(received, spended))
      })
      $('#spended-sum').trigger('change')

      $('div.tab-pane').on('change', 'input.expense-sum, input.accounting-sum', function(e){
        updateTotal(e.delegateTarget)
      })

      // Обработчик выбора наименования расхода для командировок
      $('#tab-content-1').on('change', '[id$="expenseCategory"]', function (e) {
        const selectElement = e.target
        const selectedText = selectElement.options[selectElement.selectedIndex].text
        if (['38', '40'].includes(e.target.value)) {
          const tr = $(e.target).parents('tr')
          const daysCount = $('#mission-days').val()
          if (daysCount && selectedText) {
            $.get(`/api/v1/expenseRates/?format=json&name=${selectedText}`).done((response) => {
              if (response.results != null && response.results.length > 0)
                response.results.forEach(function(el){
                  if (el.name == selectedText)
                    tr.find('[name$="expenseSumRub"]').val(daysCount * el.value)
                })
            })
          }
          tr.find('[name$="daysCount"]').val(daysCount)
        }
      })

      // Обработчик отображения формы принятия проводок
      $('#approveModal').on('show.bs.modal', function (event) {
        var modal = $(this)
        const modalDateInput = modal.find("input.approve-date")
        const approveDateInput = $("form>input.approve-date")
        modalDateInput.val(approveDateInput.val())
      })
      // Принятие проводок
      $('#approveModal').on('click', '.ok-button', function(e){
        var modal = $(e.delegateTarget)
        const modalDateInput = modal.find("input.approve-date")
        const approveDateInput = $("form>input.approve-date")
        approveDateInput.val(modalDateInput.val())
        $('#action').val('lock')
      })
      // Корректировка проводок
      $('button.unlock').on('click', function (e) {
        $('#action').val('unlock')
      })

      // Обработчик отображения форм редактирования
      $('.inventoryModal, #serviceModal, #presentationModal, #purchaseOrderModal').on('show.bs.modal', function (event) {
        // Устанавливаем ссылку на редактируемую строку
        editRow = $(event.relatedTarget).parents('tr')
        const itemType = editRow.find('input.item-type').val()

        // Получаем общие поля ввода из редактируемой строки
        var rowDocumentSelect = editRow.find('select.approve-doc')
        var rowDocNumInput = editRow.find('.doc-num')
        var rowDocDateInput = editRow.find('.doc-date')
        var rowExpenseSumRubInput = editRow.find('.expense-sum-rub')
        var rowExpenseSumVATInput = editRow.find('.expense-sum-vat')
        var rowSypherNumInput = editRow.find('.sypher-num')
        var rowSypherDateInput = editRow.find('.sypher-date')
        var rowCommentInput = editRow.find('.comment')

        var modal = $(this)
        // Получаем поля ввода на модальной форме
        var modalDocNumInput = modal.find('.doc-num')
        var modalDocDateInput = modal.find('.doc-date')
        var modalExpenseSumRubInput = modal.find('.expense-sum-rub')
        var modalExpenseSumVATInput = modal.find('.expense-sum-vat')
        var modalSypherNumInput = modal.find('.sypher-num')
        var modalSypherDateInput = modal.find('.sypher-date')
        var modalCommentInput = modal.find('.comment')
        
        // Заменяем поле выбора документа
        modal.find('#approve-doc select').remove()
        var documentSelectClone = rowDocumentSelect.clone()
        documentSelectClone.appendTo(modal.find('#approve-doc'))
        
        // Выставляем значения из редактируемой строки
        documentSelectClone.val(rowDocumentSelect.val())
        modalDocNumInput.val(rowDocNumInput.val())
        modalDocDateInput.val(rowDocDateInput.val())

        modalExpenseSumRubInput.val(rowExpenseSumRubInput.val())
        modalExpenseSumVATInput.val(rowExpenseSumVATInput.val())

        modalSypherNumInput.val(rowSypherNumInput.val())
        modalSypherDateInput.val(rowSypherDateInput.val())
        modalCommentInput.val(rowCommentInput.val())

        // Приобретение ТМЦ
        if (itemType == 2) {
          // Получаем специфические поля ввода из редактируемой строки
          var rowRouteInput = editRow.find('.route')

          // Получаем поля ввода на модальной форме
          var modalRouteInput = modal.find('.route')

          // Выставляем значения из редактируемой строки
          modalRouteInput.val(rowRouteInput.val())
        }
        // Оплата работ, услуг, Представительские расходы
        else if (itemType == 3 || itemType == 4) {
          // Получаем специфические поля ввода из редактируемой строки
          var rowAccountInput = editRow.find('.account')
          var rowKAU1Input = editRow.find('.kau-1')
          var rowKAU2Input = editRow.find('.kau-2')
          var rowExtraInput = editRow.find('.extra')

          // Получаем поля ввода на модальной форме
          var modalAccountInput = modal.find('.account')
          var modalKAU1Input = modal.find('.kau-1')
          var modalKAU2Input = modal.find('.kau-2')
          var modalExtraInput = modal.find('.extra')

          // Выставляем значения из редактируемой строки
          modalAccountInput.val(rowAccountInput.val())
          modalKAU1Input.val(rowKAU1Input.val())
          modalKAU2Input.val(rowKAU2Input.val())
          modalExtraInput.val(rowExtraInput.val())

          if (itemType == 3) {
            // Получаем специфические поля ввода из редактируемой строки
            var rowBankCommissionInput = editRow.find('.bank-commission')
            var rowService1SumRubInput = editRow.find('.service-1-sum-rub')
            var rowService1SumVATInput = editRow.find('.service-1-sum-vat')
            var rowService2SumRubInput = editRow.find('.service-2-sum-rub')
            var rowService2SumVATInput = editRow.find('.service-2-sum-vat')

            // Получаем поля ввода на модальной форме
            var modalBankCommissionInput = modal.find('.bank-commission')
            var modalService1SumRubInput = modal.find('.service-1-sum-rub')
            var modalService1SumVATInput = modal.find('.service-1-sum-vat')
            var modalService2SumRubInput = modal.find('.service-2-sum-rub')
            var modalService2SumVATInput = modal.find('.service-2-sum-vat')
    
            // Выставляем значения из редактируемой строки
            modalBankCommissionInput.val(rowBankCommissionInput.val())
            modalService1SumRubInput.val(rowService1SumRubInput.val())
            modalService1SumVATInput.val(rowService1SumVATInput.val())
            modalService2SumRubInput.val(rowService2SumRubInput.val())
            modalService2SumVATInput.val(rowService2SumVATInput.val())
          }
        }
        // Оплата заказ-наряда
        else if (itemType == 5) {
          // Получаем специфические поля ввода из редактируемой строки
          var rowMaterialSumInput = editRow.find('.material-sum')
          var rowMaterialVATInput = editRow.find('.material-vat')
          var rowOilSumInput = editRow.find('.oil-sum')
          var rowOilVATInput = editRow.find('.oil-vat')
          var rowPartSumInput = editRow.find('.part-sum')
          var rowPartVATInput = editRow.find('.part-vat')
          var rowServiceSumInput = editRow.find('.service-sum')
          var rowServiceVATInput = editRow.find('.service-vat')
          var rowRouteInput = editRow.find('.route')

          // Получаем поля ввода на модальной форме
          var modalMaterialSumInput = modal.find('.material-sum')
          var modalMaterialVATInput = modal.find('.material-vat')
          var modalOilSumInput = modal.find('.oil-sum')
          var modalOilVATInput = modal.find('.oil-vat')
          var modalPartSumInput = modal.find('.part-sum')
          var modalPartVATInput = modal.find('.part-vat')
          var modalServiceSumInput = modal.find('.service-sum')
          var modalServiceVATInput = modal.find('.service-vat')
          var modalRouteInput = modal.find('.route')

          const materialSum = parseFloat(rowMaterialSumInput.val().replace(/,/g, '.')) || 0
          const oilSum = parseFloat(rowOilSumInput.val().replace(/,/g, '.')) || 0
          const partSum = parseFloat(rowPartSumInput.val().replace(/,/g, '.')) || 0
          const serviceSum = parseFloat(rowServiceSumInput.val().replace(/,/g, '.')) || 0

          const materialVAT = parseFloat(rowMaterialVATInput.val().replace(/,/g, '.')) || 0
          const oilVAT = parseFloat(rowOilVATInput.val().replace(/,/g, '.')) || 0
          const partVAT = parseFloat(rowPartVATInput.val().replace(/,/g, '.')) || 0
          const serviceVAT = parseFloat(rowServiceVATInput.val().replace(/,/g, '.')) || 0

          if (materialSum > 0 || oilSum > 0 || partSum > 0 || serviceSum > 0){
            modalExpenseSumRubInput.val((materialSum + oilSum + partSum + serviceSum).toFixed(2))
            modalExpenseSumVATInput.val((materialVAT + oilVAT + partVAT + serviceVAT).toFixed(2))
          }

          // Выставляем значения из редактируемой строки
          modalMaterialSumInput.val(rowMaterialSumInput.val())
          modalMaterialVATInput.val(rowMaterialVATInput.val())
          modalOilSumInput.val(rowOilSumInput.val())
          modalOilVATInput.val(rowOilVATInput.val())
          modalPartSumInput.val(rowPartSumInput.val())
          modalPartVATInput.val(rowPartVATInput.val())
          modalServiceSumInput.val(rowServiceSumInput.val())
          modalServiceVATInput.val(rowServiceVATInput.val())
          modalRouteInput.val(rowRouteInput.val())
        }
      })

      // Принятие изменений из модальных форм
      $('.inventoryModal, #serviceModal, #presentationModal, #purchaseOrderModal').on('click', '.ok-button', function(e){
        var modal = $(e.delegateTarget)
        const itemType = editRow.find('input.item-type').val()

        // Получаем общие поля ввода из редактируемой строки
        var rowDocumentSelect = editRow.find('select.approve-doc')
        var rowDocNumInput = editRow.find('.doc-num')
        var rowDocDateInput = editRow.find('.doc-date')
        var rowExpenseSumRubInput = editRow.find('.expense-sum-rub')
        var rowExpenseSumVATInput = editRow.find('.expense-sum-vat')
        var rowSypherNumInput = editRow.find('.sypher-num')
        var rowSypherDateInput = editRow.find('.sypher-date')
        var rowCommentInput = editRow.find('.comment')

        // Получаем поля ввода на модальной форме
        var modalDocumentSelect = modal.find('select.approve-doc')
        var modalDocNumInput = modal.find('.doc-num')
        var modalDocDateInput = modal.find('.doc-date')
        var modalExpenseSumRubInput = modal.find('.expense-sum-rub')
        var modalExpenseSumVATInput = modal.find('.expense-sum-vat')
        var modalSypherNumInput = modal.find('.sypher-num')
        var modalSypherDateInput = modal.find('.sypher-date')
        var modalCommentInput = modal.find('.comment')

        // Выставляем значения из формы в строку
        rowDocumentSelect.val(modalDocumentSelect.val())
        rowDocNumInput.val(modalDocNumInput.val())
        rowDocDateInput.val(modalDocDateInput.val())

        rowExpenseSumRubInput.val(modalExpenseSumRubInput.val())
        rowExpenseSumVATInput.val(modalExpenseSumVATInput.val())

        rowSypherNumInput.val(modalSypherNumInput.val())
        rowSypherDateInput.val(modalSypherDateInput.val())
        rowCommentInput.val(modalCommentInput.val())

        // Приобретение ТМЦ
        if (itemType == 2) {
          // Получаем специфические поля ввода из редактируемой строки
          var rowRouteInput = editRow.find('.route')

          // Получаем поля ввода на модальной форме
          var modalRouteInput = modal.find('.route')

          // Выставляем значения из формы в строку
          rowRouteInput.val(modalRouteInput.val())
        }
        // Оплата работ, услуг, Представительские расходы
        else if (itemType == 3 || itemType == 4) {
          // Получаем специфические поля ввода из редактируемой строки
          var rowAccountInput = editRow.find('.account')
          var rowKAU1Input = editRow.find('.kau-1')
          var rowKAU2Input = editRow.find('.kau-2')
          var rowExtraInput = editRow.find('.extra')

          // Получаем поля ввода на модальной форме
          var modalAccountInput = modal.find('.account')
          var modalKAU1Input = modal.find('.kau-1')
          var modalKAU2Input = modal.find('.kau-2')
          var modalExtraInput = modal.find('.extra')

          // Выставляем значения из формы в строку
          rowAccountInput.val(modalAccountInput.val())
          rowKAU1Input.val(modalKAU1Input.val())
          rowKAU2Input.val(modalKAU2Input.val())
          rowExtraInput.val(modalExtraInput.val())

          if (itemType == 3) {
            var rowBankCommissionInput = editRow.find('.bank-commission')
            var rowService1SumRubInput = editRow.find('.service-1-sum-rub')
            var rowService1SumVATInput = editRow.find('.service-1-sum-vat')
            var rowService2SumRubInput = editRow.find('.service-2-sum-rub')
            var rowService2SumVATInput = editRow.find('.service-2-sum-vat')

            // Получаем поля ввода на модальной форме
            var modalBankCommissionInput = modal.find('.bank-commission')
            var modalService1SumRubInput = modal.find('.service-1-sum-rub')
            var modalService1SumVATInput = modal.find('.service-1-sum-vat')
            var modalService2SumRubInput = modal.find('.service-2-sum-rub')
            var modalService2SumVATInput = modal.find('.service-2-sum-vat')
    
          
            const sum1 = parseFloat(modalService1SumRubInput.val().replace(/,/g, '.')) || 0
            const sum2 = parseFloat(modalService2SumRubInput.val().replace(/,/g, '.')) || 0
            const total = parseFloat(modalExpenseSumRubInput.val().replace(/,/g, '.')) || 0

            if ((total !== sum1 + sum2) && (sum1 > 0 || sum2 > 0)) {
              alert('Неправильно разделена общая сумма по документу!');
              e.stopImmediatePropagation();
              return
            }
            
            // Выставляем значения из формы в строку
            rowBankCommissionInput.val(modalBankCommissionInput.val())
            rowService1SumRubInput.val(modalService1SumRubInput.val())
            rowService1SumVATInput.val(modalService1SumVATInput.val())
            rowService2SumRubInput.val(modalService2SumRubInput.val())
            rowService2SumVATInput.val(modalService2SumVATInput.val())
          }
        }
        // Оплата заказ-наряда
        else if (itemType == 5) {
          // Получаем специфические поля ввода из редактируемой строки
          var rowMaterialSumInput = editRow.find('.material-sum')
          var rowMaterialVATInput = editRow.find('.material-vat')
          var rowOilSumInput = editRow.find('.oil-sum')
          var rowOilVATInput = editRow.find('.oil-vat')
          var rowPartSumInput = editRow.find('.part-sum')
          var rowPartVATInput = editRow.find('.part-vat')
          var rowServiceSumInput = editRow.find('.service-sum')
          var rowServiceVATInput = editRow.find('.service-vat')
          var rowRouteInput = editRow.find('.route')

          // Получаем поля ввода на модальной форме
          var modalMaterialSumInput = modal.find('.material-sum')
          var modalMaterialVATInput = modal.find('.material-vat')
          var modalOilSumInput = modal.find('.oil-sum')
          var modalOilVATInput = modal.find('.oil-vat')
          var modalPartSumInput = modal.find('.part-sum')
          var modalPartVATInput = modal.find('.part-vat')
          var modalServiceSumInput = modal.find('.service-sum')
          var modalServiceVATInput = modal.find('.service-vat')
          var modalRouteInput = modal.find('.route')

          const materialSum = parseFloat(modalMaterialSumInput.val().replace(/,/g, '.')) || 0
          const oilSum = parseFloat(modalOilSumInput.val().replace(/,/g, '.')) || 0
          const partSum = parseFloat(modalPartSumInput.val().replace(/,/g, '.')) || 0
          const serviceSum = parseFloat(modalServiceSumInput.val().replace(/,/g, '.')) || 0

          const materialVAT = parseFloat(modalMaterialVATInput.val().replace(/,/g, '.')) || 0
          const oilVAT= parseFloat(modalOilVATInput.val().replace(/,/g, '.')) || 0
          const partVAT = parseFloat(modalPartVATInput.val().replace(/,/g, '.')) || 0
          const serviceVAT = parseFloat(modalServiceVATInput.val().replace(/,/g, '.')) || 0

          const total = parseFloat(modalExpenseSumRubInput.val().replace(/,/g, '.')) || 0

          if ((total.toFixed(2) !== (materialSum + oilSum + partSum + serviceSum).toFixed(2)) && 
          (modalMaterialSumInput.val() || modalOilSumInput.val() || modalPartSumInput.val() || modalServiceSumInput.val())) {
            alert('Неправильно разделена общая сумма по документу!');
            e.stopImmediatePropagation();
            return
          }

          // Выставляем значения из формы в строку
          rowMaterialSumInput.val(modalMaterialSumInput.val())
          rowMaterialVATInput.val(modalMaterialVATInput.val())
          rowOilSumInput.val(modalOilSumInput.val())
          rowOilVATInput.val(modalOilVATInput.val())
          rowPartSumInput.val(modalPartSumInput.val())
          rowPartVATInput.val(modalPartVATInput.val())
          rowServiceSumInput.val(modalServiceSumInput.val())
          rowServiceVATInput.val(modalServiceVATInput.val())
          rowRouteInput.val(modalRouteInput.val())

          //rowExpenseSumRubInput.val((materialSum + oilSum + partSum + serviceSum).toFixed(2))
          //rowExpenseSumVATInput.val((materialSum + oilSum + partSum + serviceSum).toFixed(2))

          if (materialSum > 0 || oilSum > 0 || partSum > 0 || serviceSum > 0){
            $('#action').val('split-' + editRow.attr('id'))
            $('form').submit()
          }
        }
      })
    })

    // Событие прикрепления файла
    $('.form-control-file').on('change', function(e) {
      const file = e.target.files[0]
      if (file) {
        const row = $(e.target).parents('tr')
        const fileNameInput = row.find('input.file-name')
        const fileDateInput = row.find('input.file-date')

        fileNameInput.val(file.name)
        fileDateInput.val(new Date().toLocaleDateString("ru-RU"))
      }
    })

    var activeTab = document.querySelector('.tab-pane.show.active')
    updateTotal(activeTab)
  </script>
{% endblock %}
